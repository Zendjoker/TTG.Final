{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static "styles/Onboarding.css" %}">
  <title>Onboarding - Tunisian Top Gs</title>
{% endblock head %}

{% block main %}
<div class="all-container">
  <div class="toploadingbar">
    <svg class="x-icon" id="quit-button" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" fill="none">
      <path d="M16.57 1L1 16.57M1 1L16.57 16.57" stroke="#BABABA" stroke-width="2" stroke-miterlimit="10" />
    </svg>
    <div class="loading-top">
      <div class="loading-fill"></div>
    </div>
    <span class="percentage">0%</span>
  </div>

  <div class="container1" id="question-container">
    {% for question in questions %}
      {% if forloop.counter == 3 %}
        <div class="question-step question-3" id="question{{ forloop.counter }}" style="display: none;">
          <div class="wrap-default">
          <span class="question-text">Great. Now choose a daily goal.</span>
          <div class="all-selection-colums">
            <div class="optionnal">
              <div class="Selec-options selec">
                <span>Casual</span>
                <span class="time"> 5 min / Day</span>
              </div>
              <div class="Selec-options selec slc2">
                <span>Regular</span>
                <span class="time"> 10 min / Day</span>
              </div>
              <div class="Selec-options selec slc2">
                <span>Serious</span>
                <span class="time"> 15 min / Day</span>
              </div>
              <div class="Selec-options selec">
                <span>Intense</span>
                <span class="time"> 20 min / Day</span>
              </div>
            </div>
          </div>
          <button class="continue" id="continue{{ forloop.counter }}" data-next="question{{ forloop.counter|add:1 }}">Continue</button>
        </div>
        </div>
      {% else %}
        <div class="question-step" id="question{{ forloop.counter }}" {% if not forloop.first %}style="display: none;"{% endif %}>
          <span class="question-text">{{ question.question }}</span>
          {% if question.image %}
            <img src="{{ question.image.url }}" alt="Question Image" class="step-image">
          {% endif %}
          <div class="all-selection">
            {% for option in question.options.all %}
              <div class="selec">
                {% if option.image %}
                  <img src="{{ option.image.url }}" alt="Option Image" class="option-image">
                {% endif %}
                <span class="selec-name">{{ option.name }}</span>
              </div>
            {% endfor %}
          </div>
          <button class="continue" id="continue{{ forloop.counter }}" data-next="question{{ forloop.counter|add:1 }}">Continue</button>
        </div>
      {% endif %}
    {% endfor %}
    <div class="question-step question-4" id="question{{ questions|length|add:1 }}" style="display: none;">
      <div class="all-selection-colums">
        <div class="optionnal">
          <img class="decoration" src="{% static 'assets/bitcoin-boarding.png' %}" alt="">
        </div>
        <span class="question-text">
          Time to practice Trading!
        </span>
        <span class="paragp">
          Enhance your trading and crypto skills with exciting technical analysis!
        </span>
        <button class="continue" id="finishQuiz">Finish Quiz</button>
      </div>
    </div>
  
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span>Are you sure you want to skip the quiz?</span>
      <button id="modal-yes">Yes</button>
      <button id="modal-no">No</button>
    </div>
  </div>
</div>
{% endblock main %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var currentQuestion = 1;
    var totalQuestions = {{ questions|length }} + 1; // Including the additional last question
    var selectionsData = [];
    var otherInput = document.getElementById('otherInput');
    var modal = document.getElementById('modal');
    var quitButton = document.getElementById('quit-button');
    var yesButton = document.getElementById('modal-yes');
    var noButton = document.getElementById('modal-no');

    function getSelectionLimit() {
        if (currentQuestion === 1 || currentQuestion === 3) {
            return 1;
        } else if (currentQuestion === 2) {
            return 3;
        }
        return 0;
    }

    function updateSelectionStatus() {
        var selectedItems = document.querySelectorAll('#question' + currentQuestion + ' .selec.selected');
        var selectedCount = selectedItems.length;
        var continueButton = document.getElementById('continue' + currentQuestion) || document.getElementById('finishQuiz');
        continueButton.disabled = selectedCount === 0 && currentQuestion !== totalQuestions;
        continueButton.classList.toggle('active', selectedCount > 0 || currentQuestion === totalQuestions);

        var isOtherSelected = Array.from(selectedItems).some(item => {
            var selecName = item.querySelector('.selec-name');
            return selecName && selecName.textContent === 'Other';
        });

        if (!isOtherSelected && otherInput) {
            otherInput.style.display = 'none';
            otherInput.value = '';
        }

        if (isOtherSelected && otherInput) {
            otherInput.addEventListener('input', function () {
                continueButton.disabled = !otherInput.value.trim();
            });
        }
    }

    function handleSelectionClick(event) {
        var selection = event.currentTarget;
        var selectedCount = document.querySelectorAll('#question' + currentQuestion + ' .selec.selected').length;

        if (selection.classList.contains('selected') || selectedCount < getSelectionLimit()) {
            selection.classList.toggle('selected');
            updateSelectionStatus();
        }

        var selecName = selection.querySelector('.selec-name');
        var isOther = selecName && selecName.textContent === 'Other';
        if (!selection.classList.contains('selected') && isOther && otherInput) {
            otherInput.style.display = 'none';
            otherInput.value = '';
            var continueButton = document.getElementById('continue' + currentQuestion) || document.getElementById('finishQuiz');
            continueButton.disabled = selectedCount === 1;
        }
    }

    function showNextQuestion() {
        if (otherInput) {
            otherInput.style.display = 'none';
            otherInput.value = '';
        }

        collectData();
        if (currentQuestion < totalQuestions) {
            document.getElementById("question" + currentQuestion).style.display = "none";
            currentQuestion++;
            var nextQuestionElem = document.getElementById("question" + currentQuestion);
            if (nextQuestionElem) {
                nextQuestionElem.style.display = "block";
                var continueButton = document.getElementById('continue' + currentQuestion) || document.getElementById('finishQuiz');
                if (currentQuestion === totalQuestions) {
                    continueButton.disabled = false;
                }
                updateSelectionStatus();
            }
        } else {
            window.location.href = '/home';
        }
        updateProgressBar();
    }

    function collectData() {
        var selectedItems = document.querySelectorAll('#question' + currentQuestion + ' .selec.selected');
        selectedItems.forEach(item => {
            selectionsData.push(item.textContent.trim());
        });
    }

    function updateProgressBar() {
        var percentage = ((currentQuestion - 1) / (totalQuestions - 1)) * 100;
        document.querySelector('.loading-fill').style.width = percentage + '%';
        document.querySelector('.percentage').textContent = percentage.toFixed(0) + '%';
    }

    function showModal() {
        if (modal) {
            modal.style.display = 'block';
        }
    }

    function hideModal() {
        if (modal) {
            modal.style.display = 'none';
        }
    }

    if (quitButton) {
        quitButton.addEventListener('click', showModal);
    }
    if (yesButton) {
        yesButton.addEventListener('click', function () {
            window.location.href = '/home';
        });
    }
    if (noButton) {
        noButton.addEventListener('click', hideModal);
    }

    document.querySelectorAll('.continue').forEach(function (button) {
        button.addEventListener('click', showNextQuestion);
    });

    document.querySelectorAll('.selec').forEach(function (selection) {
        selection.addEventListener('click', handleSelectionClick);
    });

    document.querySelectorAll('.selec').forEach(function (selection) {
        selection.addEventListener('click', function (event) {
            var selecName = event.currentTarget.querySelector('.selec-name');
            var isOtherSelected = selecName && selecName.textContent === 'Other';
            var selectedCount = document.querySelectorAll('#question' + currentQuestion + ' .selec.selected').length;

            if (isOtherSelected && selectedCount >= getSelectionLimit() && !event.currentTarget.classList.contains('selected') && otherInput) {
                otherInput.style.display = 'none';
                otherInput.value = '';
                return;
            }

            if (isOtherSelected && event.currentTarget.classList.contains('selected') && otherInput) {
                otherInput.style.display = 'block';
                var continueButton = document.getElementById('continue' + currentQuestion) || document.getElementById('finishQuiz');
                continueButton.disabled = true;

                otherInput.addEventListener('input', function () {
                    continueButton.disabled = !otherInput.value.trim();
                });
            } else if (!isOtherSelected && otherInput) {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        });
    });

    updateProgressBar();
    updateSelectionStatus();
  });
</script>
{% endblock scripts %}
